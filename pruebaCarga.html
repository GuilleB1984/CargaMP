<!DOCTYPE html>
<html>
  <head>
    <title>Carga de Producción</title>
    <!--
    
  -->
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <h1>Últimos 3 Registros Cargados</h1>
      <table id="lastRecords">
        <thead>
          <tr>
            <th>Inicio</th>
            <th>Fin</th>
            <th>Evento</th>
            <th>Nº de Caja</th>
          </tr>
        </thead>
        <tbody>
          <!-- Los últimos 3 registros se cargarán aquí con JavaScript -->
        </tbody>
      </table>

      <h1>Cargar Datos de Producción</h1>
      <form id="productionForm">
        <div class="form-group">
          <label for="startHour">Hora Inicio:</label>
          <div class="time-input">
            <input
              type="number"
              name="startHour"
              id="startHour"
              min="0"
              max="23"
              placeholder="Hora"
              required
            />
            <span class="time-separator">:</span>
            <input
              type="number"
              name="startMinute"
              id="startMinute"
              min="0"
              max="59"
              placeholder="Minuto"
              required
            />
          </div>
        </div>
        <div class="form-group">
          <label for="endHour">Hora Fin:</label>
          <div class="time-input">
            <input
              type="number"
              name="endHour"
              id="endHour"
              min="0"
              max="23"
              placeholder="Hora"
              required
            />
            <span class="time-separator">:</span>
            <input
              type="number"
              name="endMinute"
              id="endMinute"
              min="0"
              max="59"
              placeholder="Minuto"
              required
            />
          </div>
        </div>
        <div class="form-group">
          <label for="event">Evento:</label>
          <input type="text" name="event" id="event" required />
        </div>
        <div class="form-group">
          <label for="quantity">Contador:</label>
          <input type="number" name="quantity" id="quantity" min="1" required />
        </div>
        <div class="form-group">
          <label for="boxNumber">Nº de Caja:</label>
          <input
            type="number"
            name="boxNumber"
            id="boxNumber"
            min="1"
            required
          />
        </div>
        <div class="form-group">
          <label for="operator">Operario:</label>
          <input type="text" name="operator" id="operator" required />
        </div>
        <div class="form-group">
          <label for="article">Articulo:</label>
          <input type="text" name="article" id="article" required />
        </div>
        <div class="form-group">
          <label for="material">Material:</label>
          <input type="text" name="material" id="material" required />
        </div>
        <div class="form-group">
          <label for="color">Color:</label>
          <input type="text" name="color" id="color" required />
        </div>
        <div class="form-group">
          <label for="cycle">Ciclo:</label>
          <input type="text" name="cycle" id="cycle" required />
        </div>
        <div class="form-group">
          <label for="mouths">Bocas:</label>
          <input type="text" name="mouths" id="mouths" required />
        </div>
        <div class="form-group">
          <label for="observations">Observaciones:</label>
          <textarea name="observations" id="observations" rows="1"></textarea>
        </div>
        <input type="submit" value="Cargar" />
      </form>
      <div id="message"></div>
    </div>

    <script>
      const baseUrl = "https://guillermobell.pythonanywhere.com"; // Reemplaza con tu URL de PythonAnywhere

      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("productionForm");
        const messageDiv = document.getElementById("message");
        const lastRecords = document
          .getElementById("lastRecords")
          .getElementsByTagName("tbody")[0];

        form.addEventListener("submit", (event) => {
          event.preventDefault();

          const formData = new FormData(form);
          const data = {};
          formData.forEach((value, key) => {
            data[key] = value;
          });

          fetch(`${baseUrl}/add_data`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          })
            .then((response) => response.json())
            .then((data) => {
              messageDiv.textContent = data.message;
              form.reset();
              loadLastRecords();
            })
            .catch((error) => {
              messageDiv.textContent = "Error al cargar los datos.";
              console.error("Error al cargar los datos:", error);
            });
        });

        function loadLastRecords() {
          fetch(`${baseUrl}/get_data`)
            .then((response) => response.json())
            .then((data) => {
              lastRecords.innerHTML = "";
              // Ordenar los registros por la hora de carga (timestamp) de forma descendente
              const sortedData = data.sort(
                (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
              );
              // Tomar solo los últimos 3 registros
              const lastThreeRecords = sortedData.slice(0, 3);

              lastThreeRecords.forEach((record) => {
                const row = document.createElement("tr");
                const inicio = record.startHour + ":" + record.startMinute;
                const fin = record.endHour + ":" + record.endMinute;
                row.innerHTML = `
                <td>${inicio}</td>
                <td>${fin}</td>
                <td>${record.event}</td>
                <td>${record.boxNumber}</td>
              `;
                lastRecords.appendChild(row);
              });
            })
            .catch((error) =>
              console.error("Error al cargar los datos:", error)
            );
        }

        loadLastRecords();
      });
      const textarea = document.getElementById("observations");

      textarea.addEventListener("input", () => {
        // Ajustar la altura del textarea según el contenido
        textarea.style.height = "auto";
        textarea.style.height = `${textarea.scrollHeight}px`;
      });
    </script>
  </body>
</html>
