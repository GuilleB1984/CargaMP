<!DOCTYPE html>
<html>
  <head>
    <title>Carga de Producción</title>
    <!--
    
  -->
    <link rel="stylesheet" href="styles.css" />
    <style>
      
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Últimos 3 Registros</h1>
      <table id="lastRecords">
        <thead>
          <tr>
            <th style="width: 20%;">Inicio</th>
    <th style="width: 20%;">Fin</th>
    <th style="width: 20%;">Evento</th>
    <th style="width: 30%;">Nº de Caja</th>
          </tr>
        </thead>
        <tbody>
          <!-- Los últimos 3 registros se cargarán aquí con JavaScript -->
        </tbody>
      </table>

      <h1>Control de Producción</h1>
      <form id="productionForm">
        <div class="form-group">
          <label for="startHour">Hora Inicio:</label>
          <div class="time-input">
            <input
              type="number"
              name="startHour"
              id="startHour"
              min="0"
              max="23"
              placeholder="Hora"
              required
            />
            <span class="time-separator">:</span>
            <input
              type="number"
              name="startMinute"
              id="startMinute"
              min="0"
              max="59"
              placeholder="Minuto"
              required
            />
          </div>
        </div>
        <div class="form-group">
          <label for="endHour">Hora Fin:</label>
          <div class="time-input">
            <input
              type="number"
              name="endHour"
              id="endHour"
              min="0"
              max="23"
              placeholder="Hora"
              required
            />
            <span class="time-separator">:</span>
            <input
              type="number"
              name="endMinute"
              id="endMinute"
              min="0"
              max="59"
              placeholder="Minuto"
              required
            />
          </div>
        </div>
        <div class="form-group">
          <label for="event">Evento:</label>
          <input
            type="text"
            name="event"
            id="event"
            pattern="[A-L]"
            title="El evento debe ser una letra entre A y L"
            oninput="this.value = this.value.toUpperCase()"
            required
          />
        </div>
        <div class="form-group">
          <label for="quantity">Contador:</label>
          <input type="number" name="quantity" id="quantity" min="0" required />
        </div>
        <div class="form-group">
          <label for="boxNumber">Nº de Caja:</label>
          <input
            type="number"
            name="boxNumber"
            id="boxNumber"
            min="0"
            required
          />
        </div>
        <div class="form-group">
          <label for="operator">Operario:</label>
          <input type="text" name="operator" id="operator" required />
        </div>
        <div class="form-group">
          <label for="article">Articulo:</label>
          <input type="text" name="article" id="article" required />
        </div>
        <div class="form-group">
          <label for="material">Material:</label>
          <input type="text" name="material" id="material" 
            pattern="^(PP|AI)?$"
            title="El material debe ser 'PP' o 'AI', o dejarlo en blanco"
            oninput="this.value = this.value.toUpperCase()" 
          />
          <div><br></div>
          <p class="input-info">Ingresar PP, AI o dejar en blanco</p>
        </div>
        <div class="form-group">
          <label for="color">Color:</label>
          <input type="text" name="color" id="color" 
            pattern="^(NEG|NAT|BCO|CRISTAL)?$"
            title="El color debe ser 'NEG', 'NAT', 'BCO', 'CRISTAL', o dejarlo en blanco"
            oninput="this.value = this.value.toUpperCase()"
          />
          <div><br></div>
          <p class="input-info">Ingresar NEG, NAT, BCO, CRISTAL o dejar en blanco</p>
        </div>
        <div class="form-group">
          <label for="cycle">Ciclo:</label>
          <input type="number" name="cycle" id="cycle" min="0" required />
        </div>
        <div class="form-group">
          <label for="mouths">Bocas:</label>
          <input type="text" name="mouths" id="mouths" required />
        </div>
        <div class="form-group">
          <label for="observations">Obs.:</label>
          <textarea name="observations" id="observations" rows="1"></textarea>
        </div>
        <input type="submit" value="Cargar" />
      </form>
      <div id="message"></div>
    </div>

    <script>
      const baseUrl = "https://guillermobell.pythonanywhere.com"; // Reemplaza con tu URL de PythonAnywhere

      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("productionForm");
        const messageDiv = document.getElementById("message");
        const lastRecords = document
          .getElementById("lastRecords")
          .getElementsByTagName("tbody")[0];

        form.addEventListener("submit", (event) => {
          event.preventDefault();

          const formData = new FormData(form);
          const data = {};
          formData.forEach((value, key) => {
            data[key] = value;
          });

          fetch(`${baseUrl}/add_data`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          })
            .then((response) => response.json())
            .then((data) => {
              messageDiv.textContent = data.message;
              form.reset();
              loadLastRecords();
            })
            .catch((error) => {
              messageDiv.textContent = "Error al cargar los datos.";
              console.error("Error al cargar los datos:", error);
            });
        });

        function loadLastRecords() {
          fetch(`${baseUrl}/get_data`)
            .then((response) => response.json())
            .then((data) => {
              lastRecords.innerHTML = "";
              // Ordenar los registros por la hora de carga (timestamp) de forma ascendente
              const sortedData = data.sort(
                (a, b) => new Date(a.timestamp) - new Date(b.timestamp)
              );
              // Tomar solo los últimos 3 registros
              const lastThreeRecords = sortedData.slice(-3);
        
              lastThreeRecords.forEach((record) => {
                const row = document.createElement("tr");
                
                // Formatear las horas y minutos con dos dígitos
                const inicio = formatTime(record.startHour, record.startMinute);
                const fin = formatTime(record.endHour, record.endMinute);
                
                row.innerHTML = `
                <td style="width: 20%;">${inicio}</td>
                <td style="width: 20%;">${fin}</td>
                <td style="width: 20%;">${record.event}</td>
                <td style="width: 30%;">${record.boxNumber}</td>
                `;
                lastRecords.appendChild(row);
              });
            })
            .catch((error) =>
              console.error("Error al cargar los datos:", error)
            );
        }
        
        function formatTime(hours, minutes) {
          // Agregar un "0" adelante si las horas o los minutos son de una sola cifra
          const formattedHours = hours.toString().padStart(2, "0");
          const formattedMinutes = minutes.toString().padStart(2, "0");
          return `${formattedHours}:${formattedMinutes}`;
        }
        

        loadLastRecords();
      });
      const textarea = document.getElementById("observations");

      textarea.addEventListener("input", () => {
        // Ajustar la altura del textarea según el contenido
        textarea.style.height = "auto";
        textarea.style.height = `${textarea.scrollHeight}px`;
      });
    </script>
  </body>
</html>
